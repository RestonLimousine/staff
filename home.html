<!doctype html>
<html>
  <meta name="viewport" content="width=device-width, initial-scale=1">
<head>
  <style>
    h1 {
      text-align: center;
    }
    .listing-container > div {
      border: 1px solid gray;
    }
    .listing-item {
      display: flex;
    }
    .listing-item > div {
      padding: 10px;
    }
    .listing-item > div {
      border-right: 1px solid lightgray;
    }
    .listing-item > div:last-child {
      border: none;
      flex-grow: 1;
    }
    .listing-item > div:hover {
      background-color: rgba(200,200,200,0.5);
      cursor: pointer;
    }
    .details {
      display: none;
    }
    .open .details {
      display: block;
    }
  </style>
</head>
<body>
  <div id="container"></div>
  <script>
    var container = document.getElementById("container");
    
    function loadPage (pageContent) {
      container.textContent = "";
      var h1 = document.createElement("h1");
      h1.textContent = pageContent.title;
      container.appendChild(h1);
      var listingContainer = document.createElement("div");
      listingContainer.className = "listing-container";
      container.appendChild(listingContainer);
      pageContent.listing.forEach(function (item) {
        var itemDiv = document.createElement("div");
        itemDiv.className = "listing-item";
        var itemHeader = document.createElement("div");
        itemHeader.className = "item-header";
        itemHeader.textContent = item.header;
        for (var p in item.data) {
          itemHeader.dataset[p] = item.data[p];
        }
        itemDiv.appendChild(itemHeader);
        if (item.actions) {
          item.actions.forEach(function (action) {
            var actionDiv = document.createElement("div");
            actionDiv.dataset.type = action.type;
            actionDiv.dataset.data = action.data;
            actionDiv.textContent = action.text;
            itemDiv.appendChild(actionDiv);
          });
        }
        if (item.details) {
          var detailsDiv = document.createElement("div");
          detailsDiv.className = "details";
          detailsDiv.textContent = item.details;
          itemDiv.appendChild(detailsDiv);
        }
        listingContainer.appendChild(itemDiv);
      });
    }
    
    loadPage({
      title: "Choose a Resource",
      listing: [
        {
          header: "Clients",
          data: {
            repo: "clients",
            page: "listing.json"
          }
        }
      ]
    });
    
    var tokenInput = document.getElementById("token"),
        tokenIdx = location.search.indexOf("token"),
        tokenStart = tokenIdx + "token=".length,
        ampIdx = location.search.indexOf("&", tokenIdx);
    
    if (ampIdx === -1) ampIdx = location.search.length;
    
    var token = location.search.slice(tokenStart, ampIdx);
    
    function applyTemplate (template, item) {
      var copy;
      switch (template.constructor) {
        case Array:
          copy = [];
          for (var i = 0; i < template.length; i++) {
            copy[i] = applyTemplate(template[i], item);
          }
        break;
        case String:
          copy = template.replace(/\{\{[^\}]+\}\}/, function (_, m) {
            return item[m];
          });
        break;
        default:
          copy = {};
          for (var prop in template) {
            copy[prop] = applyTemplate(template[prop], item);
          }
      }
      return copy;
    }
    
    var start = true;
    
    container.addEventListener("click", function (e) {
      var target = e.target,
          dataset = target.dataset;
      if (target.classList.has("listing-item")) {
        if (start) {
          start = false;
          var repo = dataset.repo,
              page = dataset.page,
              url = "https://api.github.com/repos/RestonLimousine/" + repo + "/contents/" + page;
      
          fetch(url, {
            headers: {
              "Authorization": "token " + token,
              "User-Agent": "RestonLimousine",
              "Accept": "application/vnd.github.v3.raw"
            }
          }).then(response => response.text().then(function (text) {
            var data = JSON.parse(text);
            if (!data.listing) {
              data.listing = [];
              data.listingData.forEach(function (item) {
                data.listing.push(applyTemplate(data.listingTemplate, item));
              });
            }
            data.listing.sort(function (x, y) {
              var h1 = x.header,
                  h2 = y.header;
              return h1 > h2 ? -1 : h1 < h2 ? 1 : 0;
            });
            loadPage(data);
          }));
        } else {
          switch (dataset.type) {
            case "email":
              (function (a) {
                a.href = "mailto:" + dataset.data;
                document.body.appendChild(a);
                a.click();
                a.remove();
              })(document.createElement("a"));
            break;
            case "link": window.open(dataset.data); break;
          }
        }
      }
    }, true);
    
  </script>
</body>
</html>
