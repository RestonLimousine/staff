<!doctype html>
<html>
<head>
  <style>
    h1 {
      text-align: center;
    }
    .listing-container > div {
      padding: 10px;
      border: 1px solid gray;
    }
    .listing-container > div:hover {
      background-color: rgba(200,200,200,0.5);
      cursor: pointer;
    }
    .details {
      display: none;
    }
    .open .details {
      display: block;
    }
  </style>
</head>
<body>
  <div id="container"></div>
  <script>
    var container = document.getElementById("container");
    
    function loadPage (pageContent) {
      container.textContent = "";
      var h1 = document.createElement("h1");
      h1.textContent = pageContent.title;
      container.appendChild(h1);
      var listingContainer = document.createElement("div");
      listingContainer.className = "listing-container";
      container.appendChild(listingContainer);
      pageContent.listing.forEach(function (item) {
        var itemDiv = document.createElement("div");
        itemDiv.textContent = item.header;
        for (var p in item.data) {
          itemDiv.dataset[p] = item.data[p];
        }
        if (item.details) {
          var detailsDiv = document.createElement("div");
          detailsDiv.className = "details";
          detailsDiv.textContent = item.details;
          itemDiv.appendChild(detailsDiv);
        }
        listingContainer.appendChild(itemDiv);
      });
    }
    
    loadPage({
      title: "Choose a Resource",
      listing: [
        {
          header: "Clients",
          data: {
            repo: "clients",
            page: "listing.json"
          }
        }
      ]
    });
    
    var tokenInput = document.getElementById("token"),
        tokenIdx = location.search.indexOf("token"),
        tokenStart = tokenIdx + "token=".length,
        ampIdx = location.search.indexOf("&", tokenIdx);
    
    if (ampIdx === -1) ampIdx = location.search.length;
    
    var token = location.search.slice(tokenStart, ampIdx);
    
    var start = true;
    
    container.addEventListener("click", function (e) {
      var target = e.target,
          dataset = target.dataset;
      if (start) {
        start = false;
        var repo = dataset.repo,
            page = dataset.page,
            url = "https://api.github.com/repos/RestonLimousine/" + repo + "/contents/" + page;
      
        fetch(url, {
          headers: {
            "Authorization": "token " + token,
            "User-Agent": "RestonLimousine",
            "Accept": "application/vnd.github.v3.raw"
          }
        }).then(response => response.text().then(function (text) {
          loadPage(JSON.parse(text));
        }));
      } else {
        target.classList.toggle("open");
      }
    }, true);
    
  </script>
</body>
</html>
